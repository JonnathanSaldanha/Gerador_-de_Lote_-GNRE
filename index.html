<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Simples de Lote GNRE - Regras Atualizadas</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #0066cc;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--secondary);
            background: #f0f8ff;
        }
        
        .upload-area.dragover {
            border-color: var(--secondary);
            background: #e6f3ff;
        }
        
        .btn {
            background: var(--secondary);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #0052a3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-info {
            background: #17a2b8;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: top;
            line-height: 1.4;
        }
        
        th {
            background: var(--light);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .xml-preview {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
        }
        
        .hidden {
            display: none;
        }
        
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            min-width: 40px;
            text-align: center;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary);
            padding-bottom: 5px;
            border-bottom: 2px solid var(--secondary);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            max-width: 400px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group select {
            background: white;
        }
        
        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-success {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-ready {
            background: var(--success);
        }
        
        .status-warning {
            background: var(--warning);
        }
        
        .status-error {
            background: var(--danger);
        }
        
        .summary-card {
            background: #f8f9fa;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            margin: 15px 0;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .nfe-number {
            font-family: monospace;
            font-weight: bold;
            color: var(--primary);
            word-break: break-all;
        }
        
        .company-name {
            max-width: 120px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .valor-cell {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .valor-guia {
            color: var(--success);
            font-weight: bold;
        }
        
        .campos-manuais-row {
            background: #f8f9fa;
            border-left: 4px solid var(--warning);
        }
        
        .campos-manuais-row.hidden {
            display: none;
        }
        
        .campos-manuais-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .campos-manuais-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            flex: 1;
            min-width: 0;
        }
        
        .campo-manual-group {
            margin-bottom: 0;
        }
        
        .campo-manual-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .campo-manual-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        
        .campo-manual-info {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            line-height: 1.3;
        }
        
        /* Abas */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            border-bottom: 2px solid var(--secondary);
            color: var(--secondary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Configura√ß√µes avan√ßadas */
        .config-uf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .uf-config-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .uf-config-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .uf-config-title {
            font-weight: bold;
            color: var(--primary);
            font-size: 16px;
        }
        
        .config-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .backup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Melhorias para responsividade */
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .file-actions {
                align-self: flex-end;
            }
            
            table {
                font-size: 12px;
                min-width: 800px;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            .table-container {
                margin: 0 -10px;
                padding: 0 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .valor-cell, .valor-guia {
                font-size: 11px;
                white-space: nowrap;
            }
            
            input[type="date"] {
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 11px;
                min-width: 100px;
            }
            
            .config-uf-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .upload-area {
                padding: 20px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
                width: 100%;
                margin: 5px 0;
            }
            
            .campos-manuais-content {
                flex-direction: column;
            }
            
            .campos-manuais-grid {
                grid-template-columns: 1fr;
            }
            
            .backup-actions {
                flex-direction: column;
            }
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gerador Simples de Lote GNRE - Regras Atualizadas</h1>
            <p>Arraste os XMLs das NF-e - UF Favorecida = UF do Destinat√°rio (autom√°tico)</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="openTab('tabPrincipal')">üìã Principal</button>
            <button class="tab" onclick="openTab('tabConfig')">‚öôÔ∏è Configura√ß√µes Avan√ßadas</button>
        </div>

        <!-- ABA PRINCIPAL -->
        <div id="tabPrincipal" class="tab-content active">
            <div class="card">
                <div class="section">
                    <div class="section-title">1. Configura√ß√£o Global</div>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="receita">Receita:</label>
                            <select id="receita">
                                <option value="">-- Selecione a Receita --</option>
                                <option value="100013">100013 - ICMS Comunica√ß√£o</option>
                                <option value="100021">100021 - ICMS Energia El√©trica</option>
                                <option value="100030">100030 - ICMS Transporte</option>
                                <option value="100048">100048 - ICMS Substitui√ß√£o Tribut√°ria por Apura√ß√£o</option>
                                <option value="100056">100056 - ICMS Importa√ß√£o</option>
                                <option value="100064">100064 - ICMS Autua√ß√£o Fiscal</option>
                                <option value="100072">100072 - ICMS Parcelamento</option>
                                <option value="100080">100080 - ICMS Recolhimentos Especiais</option>
                                <option value="100099" selected>100099 - ICMS Substitui√ß√£o Tribut√°ria por Opera√ß√£o</option>
                                <option value="100102">100102 - ICMS Consumidor Final N√£o Contribuinte Outra UF por Opera√ß√£o</option>
                                <option value="100110">100110 - ICMS Consumidor Final N√£o Contribuinte Outra UF por Apura√ß√£o</option>
                                <option value="100129">100129 - ICMS Fundo Estadual de Combate √† Pobreza por Opera√ß√£o</option>
                                <option value="100137">100137 - ICMS Fundo Estadual de Combate √† Pobreza por Apura√ß√£o</option>
                                <option value="150010">150010 - ICMS D√≠vida Ativa</option>
                                <option value="500011">500011 - Multa p/ infra√ß√£o √† obriga√ß√£o acess√≥ria</option>
                                <option value="600016">600016 - Taxa</option>
                            </select>
                            <div class="info-text">Selecione o c√≥digo da receita conforme documento fiscal</div>
                        </div>
                        
                        <div class="form-group" id="detalhamentoGroup" style="display: none;">
                            <label for="detalhamento">Detalhamento da Receita (Global):</label>
                            <select id="detalhamento">
                                <option value="">-- Selecione o Detalhamento --</option>
                            </select>
                            <div class="info-text" id="detalhamentoInfo">Detalhamento obrigat√≥rio para UFs espec√≠ficas</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Para Substitui√ß√£o Tribut√°ria, o valor da guia ser√° o <strong>ICMS ST</strong> encontrado no XML.
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">2. Importar XMLs das NF-e</div>
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <h3>Arraste os XMLs das Notas Fiscais aqui</h3>
                        <p>ou clique para selecionar os arquivos</p>
                        <input type="file" id="xmlFiles" accept=".xml" multiple style="display: none;">
                    </div>
                    
                    <div id="fileList" class="hidden">
                        <div class="section-title">Arquivos Carregados</div>
                        <div id="filesContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">3. Guias Geradas Automaticamente</div>
                    
                    <div id="summaryContainer" class="hidden">
                        <div class="summary-card">
                            <strong>Resumo do Lote:</strong>
                            <span id="totalGuias">0</span> guia(s) gerada(s) | 
                            Valor Total NF-e: <span id="totalValorNFe">R$ 0,00</span> |
                            Valor Total Guias: <span id="totalValorGuia" class="valor-guia">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="120">NF-e</th>
                                    <th width="150">Emitente</th>
                                    <th width="180">Destinat√°rio (UF Favorecida)</th>
                                    <th width="120">Valor NF-e</th>
                                    <th width="120">Valor Guia (ICMS ST)</th>
                                    <th width="110">Data Venc.</th>
                                    <th width="80">Status</th>
                                    <th width="80">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="guiasTableBody">
                                <!-- Dados ser√£o preenchidos automaticamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" id="generateBtn">Gerar XML do Lote GNRE</button>
                    <button class="btn btn-warning" id="validateBtn">Validar Dados</button>
                </div>
            </div>

            <div class="card hidden" id="resultSection">
                <div class="section">
                    <div class="section-title">XML Gerado com Sucesso!</div>
                    <p>O arquivo est√° pronto para importa√ß√£o no sistema GNRE.</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-success" id="downloadBtn">üì• Baixar Arquivo XML</button>
                        <button class="btn" id="newBatchBtn">üîÑ Novo Lote</button>
                    </div>
                    
                    <div class="section-title">Pr√©via do XML:</div>
                    <div class="xml-preview" id="xmlPreview"></div>
                </div>
            </div>
        </div>

        <!-- ABA CONFIGURA√á√ïES AVAN√áADAS -->
        <div id="tabConfig" class="tab-content">
            <div class="card">
                <div class="section">
                    <div class="section-title">Configura√ß√µes Avan√ßadas por UF</div>
                    <p>Personalize as regras espec√≠ficas para cada estado. As altera√ß√µes s√£o salvas automaticamente.</p>
                    
                    <div class="config-uf-grid" id="ufConfigGrid">
                        <!-- Configura√ß√µes por UF ser√£o geradas aqui -->
                    </div>
                    
                    <div class="config-actions">
                        <button class="btn btn-success" onclick="saveAllConfigs()">üíæ Salvar Todas as Configura√ß√µes</button>
                        <button class="btn btn-info" onclick="resetToDefault()">üîÑ Restaurar Padr√µes</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Backup e Restaura√ß√£o</div>
                    <div class="backup-section">
                        <p><strong>Backup das Configura√ß√µes:</strong> Fa√ßa backup de todas as configura√ß√µes personalizadas ou restaure de um backup anterior.</p>
                        
                        <div class="backup-actions">
                            <button class="btn btn-success" onclick="exportConfigs()">üì§ Exportar Configura√ß√µes</button>
                            <button class="btn btn-warning" onclick="importConfigs()">üì• Importar Configura√ß√µes</button>
                            <input type="file" id="configFileInput" accept=".json" style="display: none;" onchange="handleConfigFileSelect(this.files)">
                        </div>
                        
                        <div class="info-text" style="margin-top: 10px;">
                            üí° Dica: Exporte suas configura√ß√µes antes de fazer grandes altera√ß√µes.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let nfesData = [];
        let configs = JSON.parse(localStorage.getItem('gnreConfigs')) || {};
        
        // ATUALIZA√á√ÉO: Regras por UF baseadas no documento oficial GNRE (vers√£o atualizada)
        let ufRules = JSON.parse(localStorage.getItem('gnreUfRules')) || {
            'AC': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio', 'numeroControle'],
                tipoDocumentoOrigem: '22',
                detalhamentos: {
                    '100099': ['000004', '000013', '000017', '000018', '000019', '000021', '000022']
                },
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '4': 'Bebidas Alco√≥licas', '85': 'Bebidas hidroeletrol√≠ticas',
                    '81': 'Bebidas Quentes', '40': 'Bicicletas e Pe√ßas', '50': 'Biodiesel B100', '44': 'Brinquedos',
                    '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados', '5': 'Cervejas, Chopes, Refrigerantes',
                    '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros', '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes',
                    '33': 'Com√©rcio Outros n√£o especificados', '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria',
                    '66': 'Derivados de petr√≥leo', '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica',
                    '78': 'Extrato concentrados', '41': 'Ferramentas', '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos',
                    '63': 'G√°s Liquefeito de Petr√≥leo', '62': 'G√°s Natural', '51': 'Gasolina A', '52': 'Gasolina C',
                    '53': 'Gasolina de Avia√ß√£o', '84': 'ICMS Complementar', '34': 'Ind√∫stria n√£o especificados',
                    '42': 'Instrumentos Musicais', '74': 'Iogurte', '77': 'Ladrilhos', '14': 'L√¢minas de Barbear',
                    '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas', '45': 'M√°quinas e Aparelhos',
                    '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias', '18': 'Materiais de Constru√ß√£o',
                    '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '69': 'Motocicletas', '60': '√ìleo Combust√≠vel',
                    '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B', '65': 'Outros Produtos',
                    '20': 'Pe√ßas para Autopropulsados', '35': 'Pecu√°ria', '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos',
                    '68': 'Produtos aliment√≠cios', '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos',
                    '23': 'Produtos Farmac√™uticos', '83': 'Provisionamento', '56': 'Querosene de Avia√ß√£o',
                    '57': 'Querosene Iluminante', '24': 'Ra√ß√µes tipo pet', '80': 'Salgados Industrializados',
                    '25': 'Sorvetes', '26': 'Suportes El√°sticos', '82': 'Telecomunica√ß√µes', '32': 'Telhas',
                    '27': 'Tintas, Vernizes', '37': 'Transporte', '28': 'Trigo, Farinha', '29': 'Ve√≠culos 4 rodas',
                    '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "68", "tipo": "T", "titulo": "OBS1.", "obrigatorio": false, "versao": "Todas"},
                    {"codigo": "69", "tipo": "T", "titulo": "OBS2.", "obrigatorio": false, "versao": "Todas"},
                    {"codigo": "76", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: ["7", "8", "10"],
                multiplosDocumentosOrigem: true,
                observacao: 'AC exige detalhamento para receita 100099 e chave de acesso da NFe'
            },
            'AL': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '22',
                produtos: {
                    '1': 'Aguardente', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '47': 'Artigos de Papelaria', '4': 'Bebidas Alco√≥licas', '5': 'Cervejas, Chopes, Refrigerantes',
                    '6': 'Cigarros', '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes', '9': 'Cosm√©ticos, Perfumaria',
                    '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica', 
                    '87': 'Energia El√©trica - Recolhimento Consumidores Livres', '41': 'Ferramentas', '12': 'Filmes Fotogr√°ficos',
                    '13': 'Gado e Produtos', '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '45': 'M√°quinas e Aparelhos',
                    '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias', '18': 'Materiais de Constru√ß√£o',
                    '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '20': 'Pe√ßas para Autopropulsados',
                    '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos', '68': 'Produtos aliment√≠cios', '23': 'Produtos Farmac√™uticos',
                    '24': 'Ra√ß√µes tipo pet', '25': 'Sorvetes', '26': 'Suportes El√°sticos', '32': 'Telhas',
                    '27': 'Tintas, Vernizes', '28': 'Trigo, Farinha', '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto',
                    '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "90", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"},
                    {"codigo": "65", "tipo": "T", "titulo": "Informa√ß√£o Complementar", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["1", "7", "8", "10"],
                multiplosDocumentosOrigem: false,
                observacao: 'Configura√ß√£o padr√£o AL'
            },
            'AP': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio'],
                tipoDocumentoOrigem: '10',
                produtos: {},
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "47", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: ["1", "10"],
                multiplosDocumentosOrigem: false,
                observacao: 'AP exige chave de acesso da NFe'
            },
            'AM': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '22',
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '86': 'Bebidas', '4': 'Bebidas Alco√≥licas', '85': 'Bebidas hidroeletrol√≠ticas',
                    '81': 'Bebidas Quentes', '40': 'Bicicletas e Pe√ßas', '50': 'Biodiesel B100', '44': 'Brinquedos',
                    '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados', '5': 'Cervejas, Chopes, Refrigerantes',
                    '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros', '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes',
                    '33': 'Com√©rcio Outros n√£o especificados', '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria',
                    '66': 'Derivados de petr√≥leo', '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica',
                    '87': 'Energia El√©trica - Recolhimento Consumidores Livres', '78': 'Extrato concentrados', '41': 'Ferramentas',
                    '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos', '63': 'G√°s Liquefeito de Petr√≥leo', '62': 'G√°s Natural',
                    '51': 'Gasolina A', '52': 'Gasolina C', '53': 'Gasolina de Avia√ß√£o', '84': 'ICMS Complementar',
                    '34': 'Ind√∫stria n√£o especificados', '42': 'Instrumentos Musicais', '74': 'Iogurte', '77': 'Ladrilhos',
                    '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas',
                    '45': 'M√°quinas e Aparelhos', '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias',
                    '18': 'Materiais de Constru√ß√£o', '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '69': 'Motocicletas',
                    '60': '√ìleo Combust√≠vel', '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B',
                    '89': 'Outros', '65': 'Outros Produtos', '90': 'Pe√ßas para Ve√≠culos', '20': 'Pe√ßas para Autopropulsados',
                    '35': 'Pecu√°ria', '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos', '68': 'Produtos aliment√≠cios',
                    '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos', '23': 'Produtos Farmac√™uticos',
                    '83': 'Provisionamento', '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante', '24': 'Ra√ß√µes tipo pet',
                    '80': 'Salgados Industrializados', '25': 'Sorvetes', '26': 'Suportes El√°sticos', '82': 'Telecomunica√ß√µes',
                    '32': 'Telhas', '27': 'Tintas, Vernizes', '37': 'Transporte', '28': 'Trigo, Farinha', '29': 'Ve√≠culos 4 rodas',
                    '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas', '88': 'Ve√≠culos e Pneum√°ticos'
                },
                exigeReferencia: true,
                periodosReferencia: ["0", "1", "2", "3", "4", "5"],
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "13", "tipo": "T", "titulo": "Observa√ß√µes", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["22"],
                multiplosDocumentosOrigem: false,
                observacao: 'Configura√ß√£o padr√£o AM com per√≠odo de refer√™ncia'
            },
            'BA': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio', 'numeroControle'],
                tipoDocumentoOrigem: '10',
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '4': 'Bebidas Alco√≥licas', '81': 'Bebidas Quentes', '40': 'Bicicletas e Pe√ßas',
                    '50': 'Biodiesel B100', '44': 'Brinquedos', '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados',
                    '5': 'Cervejas, Chopes, Refrigerantes', '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros',
                    '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes', '33': 'Com√©rcio Outros n√£o especificados',
                    '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria', '66': 'Derivados de petr√≥leo',
                    '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica', '78': 'Extrato concentrados',
                    '41': 'Ferramentas', '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos', '63': 'G√°s Liquefeito de Petr√≥leo',
                    '62': 'G√°s Natural', '51': 'Gasolina A', '52': 'Gasolina C', '53': 'Gasolina de Avia√ß√£o',
                    '34': 'Ind√∫stria n√£o especificados', '42': 'Instrumentos Musicais', '74': 'Iogurte', '77': 'Ladrilhos',
                    '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas',
                    '45': 'M√°quinas e Aparelhos', '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias',
                    '18': 'Materiais de Constru√ß√£o', '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '69': 'Motocicletas',
                    '60': '√ìleo Combust√≠vel', '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B',
                    '65': 'Outros Produtos', '20': 'Pe√ßas para Autopropulsados', '35': 'Pecu√°ria', '21': 'Pilhas, Baterias',
                    '22': 'Pneum√°ticos', '68': 'Produtos aliment√≠cios', '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos',
                    '23': 'Produtos Farmac√™uticos', '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante',
                    '24': 'Ra√ß√µes tipo pet', '80': 'Salgados Industrializados', '25': 'Sorvetes', '26': 'Suportes El√°sticos',
                    '82': 'Telecomunica√ß√µes', '32': 'Telhas', '27': 'Tintas, Vernizes', '37': 'Transporte', '28': 'Trigo, Farinha',
                    '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: true,
                periodosReferencia: ["0"],
                exigeContribuinteDestinatario: false,
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: false,
                observacao: 'BA exige c√≥digo de produto para ICMS ST'
            },
            'CE': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio'],
                tipoDocumentoOrigem: '10',
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '4': 'Bebidas Alco√≥licas', '81': 'Bebidas Quentes', '40': 'Bicicletas e Pe√ßas',
                    '50': 'Biodiesel B100', '44': 'Brinquedos', '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados',
                    '5': 'Cervejas, Chopes, Refrigerantes', '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros',
                    '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes', '33': 'Com√©rcio Outros n√£o especificados',
                    '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria', '66': 'Derivados de petr√≥leo', '10': 'Discos Fonogr√°ficos',
                    '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica', '78': 'Extrato concentrados', '41': 'Ferramentas',
                    '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos', '63': 'G√°s Liquefeito de Petr√≥leo', '62': 'G√°s Natural',
                    '51': 'Gasolina A', '52': 'Gasolina C', '53': 'Gasolina de Avia√ß√£o', '34': 'Ind√∫stria n√£o especificados',
                    '42': 'Instrumentos Musicais', '74': 'Iogurte', '77': 'Ladrilhos', '14': 'L√¢minas de Barbear',
                    '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas', '45': 'M√°quinas e Aparelhos',
                    '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias', '18': 'Materiais de Constru√ß√£o',
                    '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '69': 'Motocicletas', '60': '√ìleo Combust√≠vel',
                    '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B', '65': 'Outros Produtos',
                    '20': 'Pe√ßas para Autopropulsados', '35': 'Pecu√°ria', '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos',
                    '68': 'Produtos aliment√≠cios', '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos', '23': 'Produtos Farmac√™uticos',
                    '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante', '24': 'Ra√ß√µes tipo pet', '80': 'Salgados Industrializados',
                    '25': 'Sorvetes', '26': 'Suportes El√°sticos', '32': 'Telhas', '27': 'Tintas, Vernizes', '28': 'Trigo, Farinha',
                    '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "50", "tipo": "D", "titulo": "Data da saida da Mercadoria", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["4", "10", "25"],
                multiplosDocumentosOrigem: false,
                observacao: 'Configura√ß√£o padr√£o CE'
            },
            'DF': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '10',
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '4': 'Bebidas Alco√≥licas', '81': 'Bebidas Quentes', '40': 'Bicicletas e Pe√ßas',
                    '50': 'Biodiesel B100', '44': 'Brinquedos', '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados',
                    '5': 'Cervejas, Chopes, Refrigerantes', '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros',
                    '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes', '33': 'Com√©rcio Outros n√£o especificados',
                    '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria', '66': 'Derivados de petr√≥leo',
                    '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica', '78': 'Extrato concentrados',
                    '41': 'Ferramentas', '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos', '63': 'G√°s Liquefeito de Petr√≥leo',
                    '62': 'G√°s Natural', '51': 'Gasolina A', '52': 'Gasolina C', '53': 'Gasolina de Avia√ß√£o',
                    '34': 'Ind√∫stria n√£o especificados', '42': 'Instrumentos Musicais', '74': 'Iogurte', '77': 'Ladrilhos',
                    '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas',
                    '45': 'M√°quinas e Aparelhos', '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias',
                    '18': 'Materiais de Constru√ß√£o', '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '69': 'Motocicletas',
                    '60': '√ìleo Combust√≠vel', '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B',
                    '65': 'Outros Produtos', '20': 'Pe√ßas para Autopropulsados', '35': 'Pecu√°ria', '21': 'Pilhas, Baterias',
                    '22': 'Pneum√°ticos', '68': 'Produtos aliment√≠cios', '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos',
                    '23': 'Produtos Farmac√™uticos', '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante',
                    '24': 'Ra√ß√µes tipo pet', '80': 'Salgados Industrializados', '25': 'Sorvetes', '26': 'Suportes El√°sticos',
                    '82': 'Telecomunica√ß√µes', '32': 'Telhas', '27': 'Tintas, Vernizes', '37': 'Transporte', '28': 'Trigo, Farinha',
                    '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: true,
                exigeContribuinteDestinatario: false,
                tiposDocumento: ["10", "13"],
                multiplosDocumentosOrigem: false,
                observacao: 'Configura√ß√£o padr√£o DF'
            },
            'MA': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '22',
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '86': 'Bebidas', '4': 'Bebidas Alco√≥licas', '85': 'Bebidas hidroeletrol√≠ticas',
                    '81': 'Bebidas Quentes', '40': 'Bicicletas e Pe√ßas', '50': 'Biodiesel B100', '44': 'Brinquedos',
                    '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados', '5': 'Cervejas, Chopes, Refrigerantes',
                    '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros', '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes',
                    '33': 'Com√©rcio Outros n√£o especificados', '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria',
                    '66': 'Derivados de petr√≥leo', '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica',
                    '87': 'Energia El√©trica - Recolhimento Consumidores Livres', '78': 'Extrato concentrados', '41': 'Ferramentas',
                    '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos', '63': 'G√°s Liquefeito de Petr√≥leo', '62': 'G√°s Natural',
                    '51': 'Gasolina A', '52': 'Gasolina C', '53': 'Gasolina de Avia√ß√£o', '84': 'ICMS Complementar',
                    '34': 'Ind√∫stria n√£o especificados', '42': 'Instrumentos Musicais', '74': 'Iogurte', '77': 'Ladrilhos',
                    '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas',
                    '45': 'M√°quinas e Aparelhos', '16': 'Marketing Porta-a-Porta', '17': 'Massas Aliment√≠cias',
                    '18': 'Materiais de Constru√ß√£o', '19': 'Materiais de Limpeza', '46': 'Material El√©trico', '69': 'Motocicletas',
                    '60': '√ìleo Combust√≠vel', '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B',
                    '89': 'Outros', '65': 'Outros Produtos', '90': 'Pe√ßas para Ve√≠culos', '20': 'Pe√ßas para Autopropulsados',
                    '35': 'Pecu√°ria', '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos', '68': 'Produtos aliment√≠cios',
                    '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos', '23': 'Produtos Farmac√™uticos',
                    '83': 'Provisionamento', '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante', '24': 'Ra√ß√µes tipo pet',
                    '80': 'Salgados Industrializados', '25': 'Sorvetes', '26': 'Suportes El√°sticos', '82': 'Telecomunica√ß√µes',
                    '32': 'Telhas', '27': 'Tintas, Vernizes', '37': 'Transporte', '28': 'Trigo, Farinha', '29': 'Ve√≠culos 4 rodas',
                    '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas', '88': 'Ve√≠culos e Pneum√°ticos'
                },
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "94", "tipo": "T", "titulo": "Chave de Acesso da NFe ou do CTe/CTE-OS", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: ["7", "10", "25"],
                multiplosDocumentosOrigem: true,
                observacao: 'MA aceita m√∫ltiplos documentos origem'
            },
            'MG': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '10',
                produtos: {},
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "45", "tipo": "T", "titulo": "Informa√ß√µes Complementares", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: false,
                observacao: 'MG usa tipo 10 para NF'
            },
            'MS': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio'],
                tipoDocumentoOrigem: '10',
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '70': 'Aquisi√ß√£o de mercadorias de forma n√£o presencial', '43': 'Artefatos de Uso Dom√©stico',
                    '47': 'Artigos de Papelaria', '4': 'Bebidas Alco√≥licas', '40': 'Bicicletas e Pe√ßas', '50': 'Biodiesel B100',
                    '44': 'Brinquedos', '71': 'Caf√© Torrado e mo√≠do', '72': 'Cal√ßados', '5': 'Cervejas, Chopes, Refrigerantes',
                    '73': 'Chocolates e prepara√ß√µes similares', '6': 'Cigarros', '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes',
                    '33': 'Com√©rcio Outros n√£o especificados', '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria',
                    '66': 'Derivados de petr√≥leo', '10': 'Discos Fonogr√°ficos', '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica',
                    '78': 'Extrato concentrados', '41': 'Ferramentas', '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos',
                    '63': 'G√°s Liquefeito de Petr√≥leo', '62': 'G√°s Natural', '51': 'Gasolina A', '52': 'Gasolina C',
                    '53': 'Gasolina de Avia√ß√£o', '34': 'Ind√∫stria n√£o especificados', '42': 'Instrumentos Musicais',
                    '74': 'Iogurte', '77': 'Ladrilhos', '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas',
                    '64': 'Lubrificantes', '75': 'Luvas Cir√∫rgicas', '45': 'M√°quinas e Aparelhos', '16': 'Marketing Porta-a-Porta',
                    '17': 'Massas Aliment√≠cias', '18': 'Materiais de Constru√ß√£o', '19': 'Materiais de Limpeza',
                    '46': 'Material El√©trico', '69': 'Motocicletas', '60': '√ìleo Combust√≠vel', '61': '√ìleo de Xisto',
                    '54': '√ìleo Diesel A', '55': '√ìleo Diesel B', '65': 'Outros Produtos', '20': 'Pe√ßas para Autopropulsados',
                    '35': 'Pecu√°ria', '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos', '68': 'Produtos aliment√≠cios',
                    '58': 'Produtos Asf√°lticos', '76': 'Produtos Cer√¢micos', '23': 'Produtos Farmac√™uticos',
                    '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante', '24': 'Ra√ß√µes tipo pet', '80': 'Salgados Industrializados',
                    '25': 'Sorvetes', '26': 'Suportes El√°sticos', '32': 'Telhas', '27': 'Tintas, Vernizes', '37': 'Transporte',
                    '28': 'Trigo, Farinha', '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "27", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: false,
                observacao: 'Configura√ß√£o padr√£o MS'
            },
            'PA': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio'],
                tipoDocumentoOrigem: '22',
                produtos: {},
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "100", "tipo": "T", "titulo": "Chave de Acesso do CTe/CTE-OS", "obrigatorio": false, "versao": "Todas"},
                    {"codigo": "101", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": false, "versao": "Todas"},
                    {"codigo": "66", "tipo": "T", "titulo": "INFORMA√á√ïES COMPLEMENTARES", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["1", "10", "21"],
                multiplosDocumentosOrigem: false,
                observacao: 'PA exige chave da NFe como documento origem'
            },
            'PB': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: null,
                produtos: {},
                exigeReferencia: true,
                exigeContribuinteDestinatario: false,
                camposExtras: [
                    {"codigo": "30", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: [],
                multiplosDocumentosOrigem: false,
                observacao: 'PB n√£o exige documento de origem'
            },
            'PE': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '22',
                produtos: {
                    '1': 'Aguardente', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '4': 'Bebidas Alco√≥licas',
                    '40': 'Bicicletas e Pe√ßas', '44': 'Brinquedos', '5': 'Cervejas, Chopes, Refrigerantes', '6': 'Cigarros',
                    '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes', '9': 'Cosm√©ticos, Perfumaria', '10': 'Discos Fonogr√°ficos',
                    '11': 'Eletrodom√©sticos', '39': 'Energia El√©trica', '12': 'Filmes Fotogr√°ficos', '13': 'Gado e Produtos',
                    '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '16': 'Marketing Porta-a-Porta',
                    '17': 'Massas Aliment√≠cias', '18': 'Materiais de Constru√ß√£o', '46': 'Material El√©trico',
                    '91': 'Mercadoria Importada Exterior', '20': 'Pe√ßas para Autopropulsados', '21': 'Pilhas, Baterias',
                    '22': 'Pneum√°ticos', '23': 'Produtos Farmac√™uticos', '24': 'Ra√ß√µes tipo pet', '25': 'Sorvetes',
                    '26': 'Suportes El√°sticos', '82': 'Telecomunica√ß√µes', '27': 'Tintas, Vernizes', '28': 'Trigo, Farinha',
                    '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                tiposDocumento: ["4", "5", "6", "18", "22", "25"],
                multiplosDocumentosOrigem: true,
                observacao: 'PE aceita m√∫ltiplos documentos origem'
            },
            'PI': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio'],
                tipoDocumentoOrigem: '10',
                produtos: {
                    '1': 'Aguardente', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '4': 'Bebidas Alco√≥licas', '5': 'Cervejas, Chopes, Refrigerantes', '6': 'Cigarros', '7': 'Cimento',
                    '8': 'Combust√≠veis e Lubrificantes', '33': 'Com√©rcio Outros n√£o especificados', '9': 'Cosm√©ticos, Perfumaria',
                    '10': 'Discos Fonogr√°ficos', '12': 'Filmes Fotogr√°ficos', '34': 'Ind√∫stria n√£o especificados',
                    '14': 'L√¢minas de Barbear', '15': 'L√¢mpadas El√©tricas', '16': 'Marketing Porta-a-Porta',
                    '17': 'Massas Aliment√≠cias', '20': 'Pe√ßas para Autopropulsados', '21': 'Pilhas, Baterias',
                    '22': 'Pneum√°ticos', '23': 'Produtos Farmac√™uticos', '24': 'Ra√ß√µes tipo pet', '25': 'Sorvetes',
                    '27': 'Tintas, Vernizes', '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: false,
                observacao: 'Configura√ß√£o padr√£o PI'
            },
            'RN': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: null,
                produtos: {},
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                exigeConvenio: true,
                camposExtras: [
                    {"codigo": "97", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: [],
                multiplosDocumentosOrigem: false,
                observacao: 'RN exige conv√™nio e chave de acesso da NFe'
            },
            'RO': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '10',
                produtos: {},
                exigeReferencia: true,
                exigeContribuinteDestinatario: false,
                camposExtras: [
                    {"codigo": "83", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "Todas"}
                ],
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: true,
                observacao: 'RO exige chave de acesso da NFe'
            },
            'RS': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio', 'numeroControle'],
                tipoDocumentoOrigem: '22',
                produtos: {},
                exigeReferencia: false,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "62", "tipo": "T", "titulo": "Informa√ß√µes Complementares 1", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["22", "23", "24"],
                multiplosDocumentosOrigem: true,
                observacao: 'RS aceita m√∫ltiplos documentos origem'
            },
            'SE': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto'],
                tipoDocumentoOrigem: '10',
                produtos: {},
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "77", "tipo": "T", "titulo": "Chave de Acesso da NFe ou do CTe/CTE-OS", "obrigatorio": true, "versao": "Todas"},
                    {"codigo": "73", "tipo": "T", "titulo": "Informa√ß√µes Complementares", "obrigatorio": false, "versao": "Todas"}
                ],
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: true,
                observacao: 'SE aceita m√∫ltiplos documentos origem'
            },
            'TO': { 
                portalGNRE: true, 
                receitas: ['100099', '100102', '100129'],
                camposManuais: ['produto', 'convenio'],
                tipoDocumentoOrigem: '10',
                detalhamentos: { '100099': ['000003', '000004', '000005'] },
                produtos: {
                    '79': 'A√ß√∫car de cana', '36': 'Agricultura', '1': 'Aguardente', '48': '√Ålcool Et√≠lico Anidro',
                    '49': '√Ålcool Et√≠lico Hidratado', '2': '√Ålcool Et√≠lico Hidratado Combust√≠vel', '3': 'Aparelhos Celulares',
                    '4': 'Bebidas Alco√≥licas', '81': 'Bebidas Quentes', '50': 'Biodiesel B100', '71': 'Caf√© Torrado e mo√≠do',
                    '5': 'Cervejas, Chopes, Refrigerantes', '6': 'Cigarros', '7': 'Cimento', '8': 'Combust√≠veis e Lubrificantes',
                    '33': 'Com√©rcio Outros n√£o especificados', '38': 'Comunica√ß√£o', '59': 'Coque', '9': 'Cosm√©ticos, Perfumaria',
                    '66': 'Derivados de petr√≥leo', '10': 'Discos Fonogr√°ficos', '39': 'Energia El√©trica', '78': 'Extrato concentrados',
                    '12': 'Filmes Fotogr√°ficos', '63': 'G√°s Liquefeito de Petr√≥leo', '62': 'G√°s Natural', '51': 'Gasolina A',
                    '52': 'Gasolina C', '53': 'Gasolina de Avia√ß√£o', '34': 'Ind√∫stria n√£o especificados', '14': 'L√¢minas de Barbear',
                    '15': 'L√¢mpadas El√©tricas', '64': 'Lubrificantes', '16': 'Marketing Porta-a-Porta', '60': '√ìleo Combust√≠vel',
                    '61': '√ìleo de Xisto', '54': '√ìleo Diesel A', '55': '√ìleo Diesel B', '65': 'Outros Produtos',
                    '20': 'Pe√ßas para Autopropulsados', '21': 'Pilhas, Baterias', '22': 'Pneum√°ticos', '58': 'Produtos Asf√°lticos',
                    '23': 'Produtos Farmac√™uticos', '56': 'Querosene de Avia√ß√£o', '57': 'Querosene Iluminante', '24': 'Ra√ß√µes tipo pet',
                    '25': 'Sorvetes', '32': 'Telhas', '27': 'Tintas, Vernizes', '37': 'Transporte', '28': 'Trigo, Farinha',
                    '29': 'Ve√≠culos 4 rodas', '30': 'Ve√≠culos Faturamento Direto', '31': 'Ve√≠culos 2 rodas'
                },
                exigeReferencia: true,
                exigeContribuinteDestinatario: true,
                camposExtras: [
                    {"codigo": "80", "tipo": "T", "titulo": "Chave de Acesso da NFe", "obrigatorio": true, "versao": "2.00"}
                ],
                tiposDocumento: ["10"],
                multiplosDocumentosOrigem: false,
                observacao: 'TO exige detalhamento para receita 100099 e observa√ß√£o'
            }
        };

        // Mapeamento de c√≥digos UF para IBGE
        const ufCodes = {
            'AC': '12', 'AL': '27', 'AM': '13', 'AP': '16', 'BA': '29',
            'CE': '23', 'DF': '53', 'ES': '32', 'GO': '52', 'MA': '21',
            'MG': '31', 'MS': '50', 'MT': '51', 'PA': '15', 'PB': '25',
            'PE': '26', 'PI': '22', 'PR': '41', 'RJ': '33', 'RN': '24',
            'RO': '11', 'RR': '14', 'RS': '43', 'SC': '42', 'SE': '28',
            'SP': '35', 'TO': '17'
        };
        
        // Elementos DOM
        const uploadArea = document.getElementById('uploadArea');
        const xmlFilesInput = document.getElementById('xmlFiles');
        const fileList = document.getElementById('fileList');
        const filesContainer = document.getElementById('filesContainer');
        const guiasTableBody = document.getElementById('guiasTableBody');
        const generateBtn = document.getElementById('generateBtn');
        const validateBtn = document.getElementById('validateBtn');
        const resultSection = document.getElementById('resultSection');
        const xmlPreview = document.getElementById('xmlPreview');
        const downloadBtn = document.getElementById('downloadBtn');
        const newBatchBtn = document.getElementById('newBatchBtn');
        const receitaSelect = document.getElementById('receita');
        const summaryContainer = document.getElementById('summaryContainer');
        const totalGuias = document.getElementById('totalGuias');
        const totalValorNFe = document.getElementById('totalValorNFe');
        const totalValorGuia = document.getElementById('totalValorGuia');
        const ufConfigGrid = document.getElementById('ufConfigGrid');

        // ‚úÖ CONVERS√ÉO OFICIAL 7 ‚Üí 5 d√≠gitos conforme documento GNRE
        function converterCodigoMunicipio(codigoCompleto) {
            if (!codigoCompleto || codigoCompleto.length !== 7) {
                console.warn('C√≥digo munic√≠pio inv√°lido:', codigoCompleto);
                return codigoCompleto;
            }
            // Remove os 2 primeiros d√≠gitos (c√≥digo UF) conforme documento oficial
            return codigoCompleto.substring(2);
        }

        // ‚úÖ VALIDA√á√ÉO CONFORME REGRAS OFICIAIS
        function validateMunicipioIBGE(codigoIBGE, uf) {
            if (!codigoIBGE || codigoIBGE.length !== 5) {
                return false;
            }
            return /^\d{5}$/.test(codigoIBGE);
        }

        // ‚úÖ ESCAPE CONFORME TABELA OFICIAL GNRE
        function escapeXML(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Inicializa√ß√£o
        function init() {
            // Carregar configura√ß√µes salvas
            if (configs.receita) {
                receitaSelect.value = configs.receita;
            }
            
            updateGuiasTable();
            renderUfConfigs();
            
            // Atualizar detalhamentos quando a receita mudar
            receitaSelect.addEventListener('change', function() {
                // Para cada NFe, atualizar detalhamentos baseado na UF favorecida
                nfesData.forEach(nfe => {
                    if (nfe.ufFavorecida) {
                        updateDetalhamentoOptions(nfe.ufFavorecida, this.value);
                    }
                });
            });
        }

        // Sistema de Abas
        function openTab(tabName) {
            // Esconder todas as abas
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remover active de todas as tabs
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Mostrar a aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Renderizar configura√ß√µes por UF
        function renderUfConfigs() {
            ufConfigGrid.innerHTML = '';
            
            Object.keys(ufRules).sort().forEach(uf => {
                const rule = ufRules[uf];
                const card = document.createElement('div');
                card.className = 'uf-config-card';
                card.innerHTML = `
                    <div class="uf-config-header">
                        <div class="uf-config-title">${uf}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${rule.portalGNRE ? '‚úÖ Portal GNRE' : '‚ùå Portal Pr√≥prio'}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo Documento Origem (NF-e):</label>
                        <select onchange="updateUfRule('${uf}', 'tipoDocumentoOrigem', this.value)">
                            <option value="10" ${rule.tipoDocumentoOrigem === '10' ? 'selected' : ''}>10 - Num√©rico Simples</option>
                            <option value="22" ${rule.tipoDocumentoOrigem === '22' ? 'selected' : ''}>22 - Chave NF-e (44 d√≠gitos)</option>
                            <option value="55" ${rule.tipoDocumentoOrigem === '55' ? 'selected' : ''}>55 - NF-e Espec√≠fico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Portal GNRE:</label>
                        <select onchange="updateUfRule('${uf}', 'portalGNRE', this.value === 'true')">
                            <option value="true" ${rule.portalGNRE ? 'selected' : ''}>Sim - Usa Portal GNRE</option>
                            <option value="false" ${!rule.portalGNRE ? 'selected' : ''}>N√£o - Portal Pr√≥prio</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Campos Manuais:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <label style="display: flex; align-items: center; font-size: 12px;">
                                <input type="checkbox" ${rule.camposManuais.includes('produto') ? 'checked' : ''} 
                                       onchange="toggleCampoManual('${uf}', 'produto', this.checked)"> Produto
                            </label>
                            <label style="display: flex; align-items: center; font-size: 12px;">
                                <input type="checkbox" ${rule.camposManuais.includes('convenio') ? 'checked' : ''} 
                                       onchange="toggleCampoManual('${uf}', 'convenio', this.checked)"> Conv√™nio
                            </label>
                            <label style="display: flex; align-items: center; font-size: 12px;">
                                <input type="checkbox" ${rule.camposManuais.includes('numeroControle') ? 'checked' : ''} 
                                       onchange="toggleCampoManual('${uf}', 'numeroControle', this.checked)"> Controle
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <input type="text" value="${rule.observacao || ''}" 
                               onchange="updateUfRule('${uf}', 'observacao', this.value)"
                               placeholder="Observa√ß√µes sobre esta UF">
                    </div>
                `;
                ufConfigGrid.appendChild(card);
            });
        }

        // Atualizar regra de UF
        function updateUfRule(uf, campo, valor) {
            if (!ufRules[uf]) ufRules[uf] = {};
            ufRules[uf][campo] = valor;
            saveUfRules();
            showAlert(`Configura√ß√£o de ${uf} atualizada!`, 'success');
        }

        // Alternar campo manual
        function toggleCampoManual(uf, campo, ativo) {
            if (!ufRules[uf].camposManuais) {
                ufRules[uf].camposManuais = [];
            }
            
            if (ativo && !ufRules[uf].camposManuais.includes(campo)) {
                ufRules[uf].camposManuais.push(campo);
            } else if (!ativo && ufRules[uf].camposManuais.includes(campo)) {
                ufRules[uf].camposManuais = ufRules[uf].camposManuais.filter(c => c !== campo);
            }
            
            saveUfRules();
        }

        // Salvar regras de UF
        function saveUfRules() {
            localStorage.setItem('gnreUfRules', JSON.stringify(ufRules));
        }

        // Salvar todas as configura√ß√µes
        function saveAllConfigs() {
            saveUfRules();
            showAlert('Todas as configura√ß√µes foram salvas com sucesso!', 'success');
        }

        // Restaurar padr√µes
        function resetToDefault() {
            if (confirm('Tem certeza que deseja restaurar todas as configura√ß√µes para os valores padr√£o? Isso apagar√° todas as personaliza√ß√µes.')) {
                localStorage.removeItem('gnreUfRules');
                ufRules = JSON.parse(JSON.stringify(getDefaultUfRules()));
                renderUfConfigs();
                showAlert('Configura√ß√µes restauradas para os valores padr√£o!', 'success');
            }
        }

        // Backup e Restaura√ß√£o
        function exportConfigs() {
            const configData = {
                ufRules: ufRules,
                configs: configs,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gnre_config_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Backup das configura√ß√µes exportado com sucesso!', 'success');
        }

        function importConfigs() {
            document.getElementById('configFileInput').click();
        }

        function handleConfigFileSelect(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const configData = JSON.parse(e.target.result);
                    
                    if (configData.ufRules && configData.configs) {
                        if (confirm('Deseja importar estas configura√ß√µes? Isso substituir√° todas as configura√ß√µes atuais.')) {
                            ufRules = configData.ufRules;
                            configs = configData.configs;
                            
                            saveUfRules();
                            saveConfigs();
                            renderUfConfigs();
                            
                            if (configs.receita) {
                                receitaSelect.value = configs.receita;
                            }
                            
                            showAlert('Configura√ß√µes importadas com sucesso!', 'success');
                        }
                    } else {
                        showAlert('Arquivo de configura√ß√£o inv√°lido.', 'error');
                    }
                } catch (error) {
                    showAlert('Erro ao importar configura√ß√µes: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Event Listeners
        uploadArea.addEventListener('click', () => xmlFilesInput.click());
        xmlFilesInput.addEventListener('change', handleFileSelect);
        generateBtn.addEventListener('click', generateXML);
        validateBtn.addEventListener('click', validateData);
        downloadBtn.addEventListener('click', downloadXML);
        newBatchBtn.addEventListener('click', resetApp);
        
        // Salvar configura√ß√µes quando alteradas
        receitaSelect.addEventListener('change', saveConfigs);

        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        function saveConfigs() {
            configs.receita = receitaSelect.value;
            localStorage.setItem('gnreConfigs', JSON.stringify(configs));
        }

        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            let processed = 0;
            Array.from(files).forEach(file => {
                if (file.name.toLowerCase().endsWith('.xml')) {
                    processXMLFile(file);
                    processed++;
                }
            });
            
            if (processed === 0) {
                showAlert('Nenhum arquivo XML v√°lido foi encontrado.', 'error');
            }
        }

        function processXMLFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                    
                    // Verificar erros de parsing
                    const parseError = xmlDoc.getElementsByTagName('parsererror')[0];
                    if (parseError) {
                        throw new Error('Erro na estrutura do XML');
                    }
                    
                    // Verificar se √© uma NF-e
                    if (isNFe(xmlDoc)) {
                        const nfeData = extractNFeData(xmlDoc, file.name);
                        nfesData.push(nfeData);
                        updateFileList();
                        updateGuiasTable();
                        
                        // ATUALIZAR INFORMA√á√ïES DA UF AUTOMATICAMENTE
                        if (nfeData.ufFavorecida) {
                            updateDetalhamentoOptions(nfeData.ufFavorecida, receitaSelect.value);
                        }
                        
                        showAlert(`NF-e ${nfeData.numero} processada com sucesso!`, 'success');
                    } else {
                        showAlert(`O arquivo ${file.name} n√£o √© uma NF-e v√°lida.`, 'error');
                    }
                } catch (error) {
                    showAlert(`Erro ao processar ${file.name}: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showAlert(`Erro na leitura do arquivo ${file.name}`, 'error');
            };
            
            reader.readAsText(file);
        }

        function isNFe(xmlDoc) {
            return xmlDoc.getElementsByTagName('nfeProc').length > 0 || 
                   xmlDoc.getElementsByTagName('NFe').length > 0 ||
                   xmlDoc.documentElement.tagName === 'nfeProc' ||
                   xmlDoc.documentElement.tagName === 'NFe';
        }

        // ‚úÖ FUN√á√ÉO EXTRACT NF-E DATA COM CONVERS√ÉO OFICIAL
        function extractNFeData(xmlDoc, fileName) {
            // Encontrar a raiz da NF-e
            const nfeProc = xmlDoc.getElementsByTagName('nfeProc')[0] || xmlDoc.documentElement;
            const infNFe = nfeProc.getElementsByTagName('infNFe')[0] || nfeProc;
            
            // Extrair dados b√°sicos
            const emitente = infNFe.getElementsByTagName('emit')[0];
            const destinatario = infNFe.getElementsByTagName('dest')[0];
            const total = infNFe.getElementsByTagName('total')[0];
            const ide = infNFe.getElementsByTagName('ide')[0];
            
            // Extrair dados de endere√ßo do emitente e destinat√°rio
            const enderEmit = emitente?.getElementsByTagName('enderEmit')[0];
            const enderDest = destinatario?.getElementsByTagName('enderDest')[0];
            
            // Extrair UFs
            const ufEmitente = getUF(emitente);
            const ufDestinatario = getUF(destinatario);
            
            // ‚úÖ CONVERS√ÉO OFICIAL DOS C√ìDIGOS MUNIC√çPIO (7 ‚Üí 5 d√≠gitos)
            const codigoIBGEEmitenteRaw = enderEmit?.getElementsByTagName('cMun')[0]?.textContent || '';
            const codigoIBGEDestinatarioRaw = enderDest?.getElementsByTagName('cMun')[0]?.textContent || '';
            
            const codigoIBGEEmitente = converterCodigoMunicipio(codigoIBGEEmitenteRaw.padStart(7, '0'));
            const codigoIBGEDestinatario = converterCodigoMunicipio(codigoIBGEDestinatarioRaw.padStart(7, '0'));
            
            // Extrair valores - Buscar ICMS ST no campo correto
            let valorTotal = '0';
            let valorICMSST = '0';
            
            if (total) {
                const icmsTotal = total.getElementsByTagName('ICMSTot')[0];
                if (icmsTotal) {
                    valorTotal = icmsTotal.getElementsByTagName('vNF')[0]?.textContent || '0';
                    
                    // Buscar o valor do ICMS ST no campo <vST>
                    valorICMSST = icmsTotal.getElementsByTagName('vST')[0]?.textContent || '0';
                }
            }
            
            // Extrair chave e n√∫mero da NFe
            let chave = infNFe.getAttribute('Id') || '';
            if (chave && chave.startsWith('NFe')) {
                chave = chave.replace('NFe', '');
            }
            
            // Extrair n√∫mero da NF-e (√∫ltimos 9 d√≠gitos da chave)
            let numero = '';
            if (chave && chave.length >= 9) {
                numero = chave.substring(chave.length - 9);
            } else {
                // Tentar extrair do elemento nNF
                numero = ide?.getElementsByTagName('nNF')[0]?.textContent || chave || fileName;
            }
            
            // Configura√ß√µes
            const receita = receitaSelect.value;
            
            // Data de vencimento padr√£o (30 dias a partir de hoje)
            const dataVencimento = new Date();
            dataVencimento.setDate(dataVencimento.getDate() + 30);
            const dataVencimentoStr = dataVencimento.toISOString().split('T')[0];
            
            // Per√≠odo atual para refer√™ncia
            const now = new Date();
            const mes = String(now.getMonth() + 1).padStart(2, '0');
            const ano = now.getFullYear();
            
            // ‚úÖ TIPO DOCUMENTO ORIGEM conforme regras da UF
            const ufRule = ufRules[ufDestinatario];
            const tipoDocumentoOrigem = ufRule?.tipoDocumentoOrigem || '10';
            
            // Validar dados cr√≠ticos INCLUINDO munic√≠pios
            const status = validateNFeData(ufDestinatario, receita, valorICMSST, {}, {
                emitente: { 
                    municipio: codigoIBGEEmitente, 
                    uf: ufEmitente 
                },
                destinatario: { 
                    municipio: codigoIBGEDestinatario 
                },
                chave: chave,
                ufFavorecida: ufDestinatario
            });
            
            return {
                chave: chave,
                numero: numero,
                ufFavorecida: ufDestinatario,
                receita: receita,
                dataVencimento: dataVencimentoStr,
                valorPrincipal: valorICMSST,
                valorTotal: valorTotal,
                valorICMSST: valorICMSST,
                documentoOrigem: chave || fileName,
                tipoDocumentoOrigem: tipoDocumentoOrigem,
                periodo: {
                    mes: mes,
                    ano: ano
                },
                emitente: {
                    razaoSocial: emitente?.getElementsByTagName('xNome')[0]?.textContent || 'Emitente NF-e',
                    cnpj: emitente?.getElementsByTagName('CNPJ')[0]?.textContent || emitente?.getElementsByTagName('CPF')[0]?.textContent || '',
                    uf: ufEmitente,
                    endereco: (enderEmit?.getElementsByTagName('xLgr')[0]?.textContent || '') + 
                             (enderEmit?.getElementsByTagName('nro')[0]?.textContent ? ', ' + enderEmit.getElementsByTagName('nro')[0].textContent : '') + 
                             (enderEmit?.getElementsByTagName('xBairro')[0]?.textContent ? ' - ' + enderEmit.getElementsByTagName('xBairro')[0].textContent : '') || '',
                    municipio: codigoIBGEEmitente,
                    cep: enderEmit?.getElementsByTagName('CEP')[0]?.textContent || '',
                    telefone: enderEmit?.getElementsByTagName('fone')[0]?.textContent || ''
                },
                destinatario: {
                    razaoSocial: destinatario?.getElementsByTagName('xNome')[0]?.textContent || 'Destinat√°rio NF-e',
                    cnpj: destinatario?.getElementsByTagName('CNPJ')[0]?.textContent || destinatario?.getElementsByTagName('CPF')[0]?.textContent || '',
                    uf: ufDestinatario,
                    endereco: (enderDest?.getElementsByTagName('xLgr')[0]?.textContent || '') + 
                             (enderDest?.getElementsByTagName('nro')[0]?.textContent ? ', ' + enderDest.getElementsByTagName('nro')[0].textContent : '') + 
                             (enderDest?.getElementsByTagName('xBairro')[0]?.textContent ? ' - ' + enderDest.getElementsByTagName('xBairro')[0].textContent : '') || 'Endere√ßo n√£o informado',
                    municipio: codigoIBGEDestinatario,
                    cep: enderDest?.getElementsByTagName('CEP')[0]?.textContent || '00000000',
                    telefone: enderDest?.getElementsByTagName('fone')[0]?.textContent || '0000000000'
                },
                fileName: fileName,
                status: status,
                camposManuais: {}
            };
        }

        // ‚úÖ VALIDA√á√ÉO ESTRITA CONFORME DOCUMENTO OFICIAL
        function validateNFeData(ufFavorecida, receita, valorICMSST, camposManuais = {}, nfeData = {}) {
            if (!ufFavorecida || ufFavorecida.length !== 2) {
                return 'error';
            }
            
            const ufRule = ufRules[ufFavorecida];
            if (!ufRule) {
                return 'error';
            }
            
            if (!ufRule.portalGNRE) {
                return 'error';
            }
            
            if (!receita) {
                return 'error';
            }
            
            if (!ufRule.receitas.includes(receita)) {
                return 'error';
            }
            
            // Validar detalhamento se necess√°rio
            if (ufRule.detalhamentos && ufRule.detalhamentos[receita] && ufRule.detalhamentos[receita].length > 0) {
                const detalhamentoSelect = document.getElementById('detalhamento');
                if (!detalhamentoSelect || !detalhamentoSelect.value) {
                    return 'warning';
                }
            }
            
            // Validar produtos se necess√°rio
            if (ufRule.produtos && Object.keys(ufRule.produtos).length > 0) {
                if (!camposManuais.produto || !camposManuais.produto.trim()) {
                    return 'warning';
                }
                
                // Validar se o c√≥digo do produto existe na lista da UF
                if (!ufRule.produtos[camposManuais.produto]) {
                    return 'warning';
                }
            }
            
            // ‚úÖ VALIDA√á√ÉO C√ìDIGOS IBGE DOS MUNIC√çPIOS (5 d√≠gitos)
            if (nfeData.emitente && nfeData.emitente.municipio) {
                if (!validateMunicipioIBGE(nfeData.emitente.municipio, nfeData.emitente.uf)) {
                    return 'error';
                }
            }
            
            if (nfeData.destinatario && nfeData.destinatario.municipio) {
                if (!validateMunicipioIBGE(nfeData.destinatario.municipio, ufFavorecida)) {
                    return 'error';
                }
            }
            
            // Validar campos manuais obrigat√≥rios
            if (ufRule.camposManuais) {
                for (const campo of ufRule.camposManuais) {
                    if (!camposManuais[campo] || !camposManuais[campo].trim()) {
                        return 'warning';
                    }
                }
            }
            
            // Validar conv√™nio se exigido
            if (ufRule.exigeConvenio && (!camposManuais.convenio || !camposManuais.convenio.trim())) {
                return 'warning';
            }
            
            if (!valorICMSST || parseFloat(valorICMSST) <= 0) {
                return 'warning';
            }
            
            return 'ready';
        }

        function getUF(element) {
            if (!element) return '';
            
            const uf = element.getElementsByTagName('UF')[0]?.textContent || 
                      element.getElementsByTagName('cUF')[0]?.textContent ||
                      '';
            
            if (uf && !isNaN(uf)) {
                return convertCodigoUFparaSigla(uf);
            }
            
            return uf;
        }

        function convertCodigoUFparaSigla(codigo) {
            const ufs = {
                '12': 'AC', '27': 'AL', '16': 'AM', '13': 'AP', '29': 'BA',
                '23': 'CE', '53': 'DF', '32': 'ES', '52': 'GO', '21': 'MA',
                '31': 'MG', '50': 'MS', '51': 'MT', '15': 'PA', '25': 'PB',
                '41': 'PR', '26': 'PE', '22': 'PI', '33': 'RJ', '24': 'RN',
                '43': 'RS', '11': 'RO', '14': 'RR', '42': 'SC', '35': 'SP',
                '28': 'SE', '17': 'TO'
            };
            return ufs[codigo] || codigo;
        }

        // Fun√ß√£o para atualizar op√ß√µes de detalhamento baseado na UF e receita
        function updateDetalhamentoOptions(uf, receita) {
            const detalhamentoGroup = document.getElementById('detalhamentoGroup');
            const detalhamentoSelect = document.getElementById('detalhamento');
            const detalhamentoInfo = document.getElementById('detalhamentoInfo');
            
            // Limpar op√ß√µes atuais
            detalhamentoSelect.innerHTML = '<option value="">-- Selecione o Detalhamento --</option>';
            
            const ufRule = ufRules[uf];
            if (ufRule && ufRule.detalhamentos && ufRule.detalhamentos[receita] && ufRule.detalhamentos[receita].length > 0) {
                detalhamentoGroup.style.display = 'block';
                
                ufRule.detalhamentos[receita].forEach(codigo => {
                    const option = document.createElement('option');
                    option.value = codigo;
                    option.textContent = `${codigo} - Detalhamento ${codigo}`;
                    detalhamentoSelect.appendChild(option);
                });
                
                detalhamentoInfo.textContent = `Detalhamento obrigat√≥rio para ${uf} - Receita ${receita}`;
            } else {
                detalhamentoGroup.style.display = 'none';
            }
        }

        function updateFileList() {
            if (nfesData.length === 0) {
                fileList.classList.add('hidden');
                return;
            }
            
            fileList.classList.remove('hidden');
            filesContainer.innerHTML = '';
            
            nfesData.forEach((nfe, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <strong>${nfe.fileName}</strong>
                        <div style="font-size: 12px; color: #666;">
                            ${nfe.emitente.uf} ‚Üí ${nfe.destinatario.uf} | 
                            Valor NF-e: R$ ${parseFloat(nfe.valorTotal).toLocaleString('pt-BR', {minimumFractionDigits: 2})} |
                            ICMS ST: R$ ${parseFloat(nfe.valorICMSST).toLocaleString('pt-BR', {minimumFractionDigits: 2})} |
                            <span class="status-indicator status-${nfe.status}"></span>
                            ${getStatusText(nfe.status)}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn delete-btn" onclick="removeNFe(${index})">Remover</button>
                    </div>
                `;
                filesContainer.appendChild(fileItem);
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'ready': return 'Pronto';
                case 'warning': return 'Aten√ß√£o';
                case 'error': return 'Erro';
                default: return 'Desconhecido';
            }
        }

        function updateGuiasTable() {
            guiasTableBody.innerHTML = '';
            
            if (nfesData.length === 0) {
                summaryContainer.classList.add('hidden');
                return;
            }
            
            summaryContainer.classList.remove('hidden');
            
            let valorTotalNFe = 0;
            let valorTotalGuia = 0;
            
            nfesData.forEach((nfe, index) => {
                valorTotalNFe += parseFloat(nfe.valorTotal);
                valorTotalGuia += parseFloat(nfe.valorICMSST);
                
                const ufRule = ufRules[nfe.ufFavorecida];
                const precisaCamposManuais = ufRule && ufRule.camposManuais && ufRule.camposManuais.length > 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="nfe-number">${nfe.numero}</td>
                    <td>
                        <div class="company-name" title="${nfe.emitente.razaoSocial}">
                            ${nfe.emitente.razaoSocial}
                        </div>
                        <small>(${nfe.emitente.uf})</small>
                    </td>
                    <td>
                        <div class="company-name" title="${nfe.destinatario.razaoSocial}">
                            ${nfe.destinatario.razaoSocial}
                        </div>
                        <small><strong>(${nfe.ufFavorecida})</strong></small>
                    </td>
                    <td class="valor-cell">R$ ${parseFloat(nfe.valorTotal).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="valor-guia">R$ ${parseFloat(nfe.valorICMSST).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>
                        <input type="date" value="${nfe.dataVencimento}" 
                               onchange="updateVencimento(${index}, this.value)" 
                               style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-size: 11px; min-width: 100px;">
                    </td>
                    <td>
                        <span class="status-indicator status-${nfe.status}"></span>
                        ${getStatusText(nfe.status)}
                    </td>
                    <td>
                        ${precisaCamposManuais ? `<button class="action-btn" onclick="toggleCamposManuais(${index})" title="Campos Manuais" style="background: var(--warning); color: white;">üìù</button>` : ''}
                        <button class="action-btn delete-btn" onclick="removeNFe(${index})" title="Remover">‚ùå</button>
                    </td>
                `;
                guiasTableBody.appendChild(row);
                
                // Adicionar linha expand√≠vel para campos manuais
                if (precisaCamposManuais) {
                    const expandRow = document.createElement('tr');
                    expandRow.id = `camposManuaisRow-${index}`;
                    expandRow.className = 'campos-manuais-row hidden';
                    expandRow.innerHTML = `
                        <td colspan="8" style="background: #f8f9fa; padding: 20px;">
                            <div class="campos-manuais-content">
                                <div style="flex: 1; min-width: 0;">
                                    <strong style="display: block; margin-bottom: 15px; color: var(--primary);">
                                        üìù Campos Manuais para ${nfe.ufFavorecida} - NF-e ${nfe.numero}
                                    </strong>
                                    <div class="campos-manuais-grid">
                                        ${ufRule.camposManuais.includes('produto') ? `
                                        <div class="campo-manual-group">
                                            <label for="produto-${index}">C√≥digo do Produto:</label>
                                            <input type="text" 
                                                   id="produto-${index}" 
                                                   value="${nfe.camposManuais?.produto || ''}"
                                                   onchange="updateCampoManual(${index}, 'produto', this.value)"
                                                   placeholder="Ex: 0101010">
                                            <div class="campo-manual-info">C√≥digo do produto conforme tabela da UF</div>
                                        </div>
                                        ` : ''}
                                        
                                        ${ufRule.camposManuais.includes('convenio') ? `
                                        <div class="campo-manual-group">
                                            <label for="convenio-${index}">N√∫mero do Conv√™nio:</label>
                                            <input type="text" 
                                                   id="convenio-${index}" 
                                                   value="${nfe.camposManuais?.convenio || ''}"
                                                   onchange="updateCampoManual(${index}, 'convenio', this.value)"
                                                   placeholder="Ex: 123/2023">
                                            <div class="campo-manual-info">N√∫mero do conv√™nio/autoriza√ß√£o</div>
                                        </div>
                                        ` : ''}
                                        
                                        ${ufRule.camposManuais.includes('numeroControle') ? `
                                        <div class="campo-manual-group">
                                            <label for="controle-${index}">N√∫mero de Controle:</label>
                                            <input type="text" 
                                                   id="controle-${index}" 
                                                   value="${nfe.camposManuais?.numeroControle || ''}"
                                                   onchange="updateCampoManual(${index}, 'numeroControle', this.value)"
                                                   placeholder="Ex: CONTROLE123">
                                            <div class="campo-manual-info">N√∫mero de controle interno</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <button class="action-btn" onclick="toggleCamposManuais(${index})" 
                                        style="background: #6c757d; color: white; align-self: flex-start;">
                                    ‚úï Fechar
                                </button>
                            </div>
                        </td>
                    `;
                    guiasTableBody.appendChild(expandRow);
                }
            });
            
            // Atualizar resumo
            totalGuias.textContent = nfesData.length;
            totalValorNFe.textContent = `R$ ${valorTotalNFe.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            totalValorGuia.textContent = `R$ ${valorTotalGuia.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        // Fun√ß√£o para expandir/recolher campos manuais de uma guia espec√≠fica
        function toggleCamposManuais(index) {
            const row = document.getElementById(`camposManuaisRow-${index}`);
            if (row) {
                row.classList.toggle('hidden');
            }
        }

        // Fun√ß√£o para atualizar campos manuais de uma guia espec√≠fica
        function updateCampoManual(index, campo, valor) {
            if (!nfesData[index].camposManuais) {
                nfesData[index].camposManuais = {};
            }
            nfesData[index].camposManuais[campo] = valor;
            
            // Atualizar status da guia
            nfesData[index].status = validateNFeData(
                nfesData[index].ufFavorecida, 
                nfesData[index].receita, 
                nfesData[index].valorICMSST,
                nfesData[index].camposManuais,
                {
                    emitente: nfesData[index].emitente,
                    destinatario: nfesData[index].destinatario,
                    chave: nfesData[index].chave,
                    ufFavorecida: nfesData[index].ufFavorecida
                }
            );
            
            updateFileList();
            updateGuiasTable();
        }

        function removeNFe(index) {
            nfesData.splice(index, 1);
            updateFileList();
            updateGuiasTable();
        }

        function updateVencimento(index, newDate) {
            nfesData[index].dataVencimento = newDate;
        }

        function validateData() {
            if (nfesData.length === 0) {
                showAlert('Nenhuma NF-e carregada para valida√ß√£o.', 'warning');
                return;
            }
            
            const errors = [];
            const warnings = [];
            
            nfesData.forEach((nfe, index) => {
                const ufRule = ufRules[nfe.ufFavorecida];
                
                if (!ufRule) {
                    errors.push(`NF-e ${nfe.numero}: UF favorecida "${nfe.ufFavorecida}" n√£o reconhecida`);
                } else if (!ufRule.portalGNRE) {
                    errors.push(`NF-e ${nfe.numero}: ${nfe.ufFavorecida} utiliza portal pr√≥prio - n√£o √© poss√≠vel gerar GNRE pelo sistema nacional`);
                }
                
                if (!nfe.ufFavorecida || nfe.ufFavorecida.length !== 2) {
                    errors.push(`NF-e ${nfe.numero}: UF favorecida inv√°lida`);
                }
                
                if (!nfe.receita) {
                    errors.push(`NF-e ${nfe.numero}: Receita n√£o selecionada`);
                } else if (ufRule && !ufRule.receitas.includes(nfe.receita)) {
                    errors.push(`NF-e ${nfe.numero}: Receita ${nfe.receita} n√£o habilitada para ${nfe.ufFavorecida}`);
                }
                
                // Validar detalhamento se necess√°rio
                if (ufRule && ufRule.detalhamentos && ufRule.detalhamentos[nfe.receita] && ufRule.detalhamentos[nfe.receita].length > 0) {
                    const detalhamentoSelect = document.getElementById('detalhamento');
                    if (!detalhamentoSelect || !detalhamentoSelect.value) {
                        errors.push(`NF-e ${nfe.numero}: Detalhamento da receita obrigat√≥rio para ${nfe.ufFavorecida}`);
                    }
                }
                
                // ‚úÖ VALIDA√á√ÉO C√ìDIGOS IBGE DOS MUNIC√çPIOS (5 d√≠gitos)
                if (nfe.emitente && nfe.emitente.municipio) {
                    if (!validateMunicipioIBGE(nfe.emitente.municipio, nfe.emitente.uf)) {
                        errors.push(`NF-e ${nfe.numero}: C√≥digo IBGE do munic√≠pio do emitente inv√°lido (${nfe.emitente.municipio}) para UF ${nfe.emitente.uf}`);
                    }
                }
                
                if (nfe.destinatario && nfe.destinatario.municipio) {
                    if (!validateMunicipioIBGE(nfe.destinatario.municipio, nfe.ufFavorecida)) {
                        errors.push(`NF-e ${nfe.numero}: C√≥digo IBGE do munic√≠pio do destinat√°rio inv√°lido (${nfe.destinatario.municipio}) para UF ${nfe.ufFavorecida}`);
                    }
                }
                
                // Validar campos manuais obrigat√≥rios individuais
                if (ufRule && ufRule.camposManuais) {
                    if (ufRule.camposManuais.includes('produto') && (!nfe.camposManuais?.produto || !nfe.camposManuais.produto.trim())) {
                        warnings.push(`NF-e ${nfe.numero}: C√≥digo do produto obrigat√≥rio para ${nfe.ufFavorecida} - clique no √≠cone üìù para preencher`);
                    }
                    
                    if (ufRule.camposManuais.includes('convenio') && (!nfe.camposManuais?.convenio || !nfe.camposManuais.convenio.trim())) {
                        warnings.push(`NF-e ${nfe.numero}: N√∫mero do conv√™nio recomendado para ${nfe.ufFavorecida} - clique no √≠cone üìù para preencher`);
                    }
                }
                
                if (!nfe.emitente.cnpj) {
                    warnings.push(`NF-e ${nfe.numero}: CNPJ do emitente n√£o encontrado`);
                }
                
                if (parseFloat(nfe.valorICMSST) <= 0) {
                    warnings.push(`NF-e ${nfe.numero}: ICMS ST zerado ou negativo - verifique o XML`);
                }
            });
            
            let message = '';
            if (errors.length > 0) {
                message += `<strong>Erros cr√≠ticos:</strong><br>${errors.join('<br>')}`;
            }
            if (warnings.length > 0) {
                if (message) message += '<br><br>';
                message += `<strong>Aten√ß√£o:</strong><br>${warnings.join('<br>')}`;
            }
            if (!message) {
                message = 'Todas as guias est√£o v√°lidas e prontas para gera√ß√£o!';
            }
            
            showAlert(message, errors.length > 0 ? 'error' : (warnings.length > 0 ? 'warning' : 'success'));
        }

        // ‚úÖ FUN√á√ÉO GENERATE XML CORRIGIDA COM ORDEM OFICIAL
        function generateXML() {
            if (nfesData.length === 0) {
                showAlert('Por favor, importe pelo menos uma NF-e antes de gerar o XML.', 'error');
                return;
            }
            
            const receita = receitaSelect.value;
            
            if (!receita) {
                showAlert('Por favor, selecione a Receita.', 'error');
                return;
            }
            
            // Validar dados antes de gerar
            const hasErrors = nfesData.some(nfe => nfe.status === 'error');
            if (hasErrors) {
                showAlert('Existem erros nas guias. Corrija-os antes de gerar o XML.', 'error');
                return;
            }
            
            // ‚úÖ ESTRUTURA XML CORRIGIDA CONFORME DOCUMENTO OFICIAL
            let xmlContent = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n`;
            xmlContent += `<TLote_GNRE versao="2.00" xmlns="http://www.gnre.pe.gov.br">\n`;
            xmlContent += `  <guias>\n`;
            
            nfesData.forEach(nfe => {
                xmlContent += `    <TDadosGNRE versao="2.00">\n`;
                
                // ‚úÖ ORDEM OFICIAL EXATA DOS CAMPOS
                xmlContent += `      <ufFavorecida>${nfe.ufFavorecida}</ufFavorecida>\n`;
                xmlContent += `      <tipoGnre>0</tipoGnre>\n`; // 0 - Guia Simples
                
                // Contribuinte Emitente (na ordem oficial)
                xmlContent += `      <contribuinteEmitente>\n`;
                xmlContent += `        <identificacao>\n`;
                xmlContent += `          <CNPJ>${nfe.emitente.cnpj}</CNPJ>\n`;
                xmlContent += `        </identificacao>\n`;
                xmlContent += `        <razaoSocial>${escapeXML(nfe.emitente.razaoSocial)}</razaoSocial>\n`;
                
                // ‚úÖ ELEMENTOS NA ORDEM EXATA DO DOCUMENTO
                if (nfe.emitente.endereco && nfe.emitente.endereco.trim()) {
                    xmlContent += `        <endereco>${escapeXML(nfe.emitente.endereco)}</endereco>\n`;
                }
                if (nfe.emitente.municipio && nfe.emitente.municipio.trim()) {
                    xmlContent += `        <municipio>${nfe.emitente.municipio}</municipio>\n`;
                }
                if (nfe.emitente.uf && nfe.emitente.uf.trim()) {
                    xmlContent += `        <uf>${nfe.emitente.uf}</uf>\n`;
                }
                if (nfe.emitente.cep && nfe.emitente.cep.trim()) {
                    xmlContent += `        <cep>${nfe.emitente.cep}</cep>\n`;
                }
                if (nfe.emitente.telefone && nfe.emitente.telefone.trim()) {
                    xmlContent += `        <telefone>${nfe.emitente.telefone}</telefone>\n`;
                }
                xmlContent += `      </contribuinteEmitente>\n`;
                
                // Itens GNRE
                xmlContent += `      <itensGNRE>\n`;
                xmlContent += `        <item>\n`;
                
                // ‚úÖ ORDEM INTERNA DO ITEM conforme documento
                xmlContent += `          <receita>${nfe.receita}</receita>\n`;
                
                // Detalhamento (se aplic√°vel)
                const detalhamentoSelect = document.getElementById('detalhamento');
                if (detalhamentoSelect && detalhamentoSelect.value) {
                    xmlContent += `          <detalhamentoReceita>${detalhamentoSelect.value}</detalhamentoReceita>\n`;
                }
                
                // Documento Origem
                const ufRule = ufRules[nfe.ufFavorecida];
                let tipoDocumento = ufRule?.tipoDocumentoOrigem || '10';
                xmlContent += `          <documentoOrigem tipo="${tipoDocumento}">${nfe.documentoOrigem}</documentoOrigem>\n`;
                
                // Produto
                if (nfe.camposManuais?.produto) {
                    xmlContent += `          <produto>${escapeXML(nfe.camposManuais.produto.trim())}</produto>\n`;
                }
                
                // Refer√™ncia
                xmlContent += `          <referencia>\n`;
                xmlContent += `            <periodo>0</periodo>\n`;
                xmlContent += `            <mes>${nfe.periodo.mes}</mes>\n`;
                xmlContent += `            <ano>${nfe.periodo.ano}</ano>\n`;
                xmlContent += `          </referencia>\n`;
                
                // Data Vencimento
                xmlContent += `          <dataVencimento>${nfe.dataVencimento}</dataVencimento>\n`;
                
                // Valor Principal
                xmlContent += `          <valor tipo="11">${parseFloat(nfe.valorICMSST).toFixed(2)}</valor>\n`;
                
                // Conv√™nio
                if (nfe.camposManuais?.convenio) {
                    xmlContent += `          <convenio>${escapeXML(nfe.camposManuais.convenio.trim())}</convenio>\n`;
                }
                
                // Contribuinte Destinat√°rio
                xmlContent += `          <contribuinteDestinatario>\n`;
                xmlContent += `            <identificacao>\n`;
                xmlContent += `              <CNPJ>${nfe.destinatario.cnpj}</CNPJ>\n`;
                xmlContent += `            </identificacao>\n`;
                xmlContent += `            <razaoSocial>${escapeXML(nfe.destinatario.razaoSocial)}</razaoSocial>\n`;
                xmlContent += `            <municipio>${nfe.destinatario.municipio}</municipio>\n`;
                xmlContent += `          </contribuinteDestinatario>\n`;
                
                // N√∫mero de Controle
                if (nfe.camposManuais?.numeroControle) {
                    xmlContent += `          <numeroControle>${escapeXML(nfe.camposManuais.numeroControle.trim())}</numeroControle>\n`;
                }
                
                xmlContent += `        </item>\n`;
                xmlContent += `      </itensGNRE>\n`;
                
                // ‚úÖ CAMPOS FINAIS na ordem correta
                xmlContent += `      <valorGNRE>${parseFloat(nfe.valorICMSST).toFixed(2)}</valorGNRE>\n`;
                xmlContent += `      <dataPagamento>${nfe.dataVencimento}</dataPagamento>\n`;
                
                xmlContent += `    </TDadosGNRE>\n`;
            });
            
            xmlContent += `  </guias>\n`;
            xmlContent += `</TLote_GNRE>`;
            
            // Mostrar resultado
            xmlPreview.textContent = xmlContent;
            resultSection.classList.remove('hidden');
            window.generatedXML = xmlContent;
            
            // Salvar configura√ß√µes
            saveConfigs();
            
            // Rolagem para o resultado
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            showAlert('XML gerado com sucesso! Clique em "Baixar Arquivo XML" para salvar.', 'success');
        }

        function downloadXML() {
            if (!window.generatedXML) return;
            
            const blob = new Blob([window.generatedXML], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lote_gnre_${new Date().toISOString().slice(0, 10)}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetApp() {
            nfesData = [];
            xmlFilesInput.value = '';
            fileList.classList.add('hidden');
            resultSection.classList.add('hidden');
            updateGuiasTable();
            showAlert('Aplica√ß√£o reiniciada. Voc√™ pode come√ßar um novo lote.', 'success');
        }

        function showAlert(message, type = 'info') {
            // Remover alertas anteriores
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            // Inserir ap√≥s o header
            document.querySelector('.container').insertBefore(alert, document.querySelector('.card'));
            
            // Auto-remover ap√≥s 10 segundos para mensagens de sucesso/info
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 10000);
            }
        }

        // Fun√ß√£o auxiliar para obter regras padr√£o
        function getDefaultUfRules() {
            return {
                'AC': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'AL': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'AP': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' },
                'AM': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'BA': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'CE': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' },
                'DF': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'ES': { portalGNRE: false, receitas: [], camposManuais: [], tipoDocumentoOrigem: '10' },
                'GO': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'MA': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'MT': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'MS': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' },
                'MG': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '55' },
                'PA': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' },
                'PB': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'PR': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'PE': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'PI': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' },
                'RJ': { portalGNRE: false, receitas: [], camposManuais: [], tipoDocumentoOrigem: '10' },
                'RN': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'RS': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'RO': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'RR': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' },
                'SC': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio', 'numeroControle'], tipoDocumentoOrigem: '22' },
                'SP': { portalGNRE: false, receitas: [], camposManuais: [], tipoDocumentoOrigem: '10' },
                'SE': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto'], tipoDocumentoOrigem: '22' },
                'TO': { portalGNRE: true, receitas: ['100099', '100102', '100129'], camposManuais: ['produto', 'convenio'], tipoDocumentoOrigem: '22' }
            };
        }

        // Inicializa√ß√£o
        init();
    </script>
</body>
</html>
